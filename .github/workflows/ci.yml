name: CI

permissions:
  contents: read

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  validate:
    name: Build and Validate
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --audit-level=high

      - name: Lint and Type-check
        run: npm run check

      - name: Run unit tests
        run: npm run test

      - name: Build application
        run: npm run build

      - name: Generate Dynamic Config
        run: |
          RANDOM_PORT=$(shuf -i 10000-60000 -n 1)
          echo "APP_PORT=$RANDOM_PORT" >> $GITHUB_ENV

          # Generate unique suffix
          SUFFIX="ci_$(openssl rand -hex 8)"

          # Set project name
          echo "COMPOSE_PROJECT_NAME=ideon_$SUFFIX" >> $GITHUB_ENV

          # Export DB credentials to GITHUB_ENV for Docker Compose interpolation
          echo "DB_USER=ci_user" >> $GITHUB_ENV
          echo "DB_PASS=ci_pass" >> $GITHUB_ENV
          echo "DB_NAME=ci_db" >> $GITHUB_ENV

          # Create isolated .env for app container
          cat <<EOF > .env.ci
          COMPOSE_PROJECT_NAME=ideon_$SUFFIX
          APP_PORT=$RANDOM_PORT
          APP_URL=http://localhost:$RANDOM_PORT
          DB_USER=ci_user
          DB_PASS=ci_pass
          DB_NAME=ci_db
          SECRET_KEY=ci_secret
          NODE_ENV=production
          NEXT_TELEMETRY_DISABLED=1
          EOF

          # Create CI compose file with unique volumes to guarantee fresh install
          # We replace volume names and remove fixed container names
          sed -e "s/ideon-app-data/ideon-app-data-$SUFFIX/g" \
              -e "s/ideon-db-data/ideon-db-data-$SUFFIX/g" \
              -e '/container_name:/d' \
              -e "s|image: ghcr.io/3xpyth0n/ideon:latest|build: .|g" \
              docker-compose.yml > docker-compose.ci.yml

      - name: Start Stack (Production Simulation)
        env:
          ENV_FILE: .env.ci
        run: docker compose -f docker-compose.ci.yml --env-file .env.ci up -d --build --wait

      - name: Show logs on failure
        if: failure()
        env:
          ENV_FILE: .env.ci
        run: docker compose -f docker-compose.ci.yml --env-file .env.ci logs

      - name: Teardown
        if: always()
        env:
          ENV_FILE: .env.ci
        run: docker compose -f docker-compose.ci.yml --env-file .env.ci down -v --rmi local

  shellcheck:
    name: Shell script linting
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38 # v2.0.0
        with:
          scandir: "."
          format: gcc
          severity: error
          shell: bash

  secret-scan:
    name: Secret scanning
    if: github.actor != 'nektos/act'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@94fdf01214232715294e27e66eab2a6dad568d21 # v3.92.5
        with:
          path: ./
          base: ${{ github.event_name == 'push' && github.event.before || (github.event_name == 'pull_request' && github.event.pull_request.base.sha || '') }}
          head: ${{ github.event_name == 'push' && github.event.after || (github.event_name == 'pull_request' && github.event.pull_request.head.sha || 'HEAD') }}
