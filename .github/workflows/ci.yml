name: CI

permissions:
  contents: read

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - ".gitignore"
  pull_request:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "LICENSE"
      - ".gitignore"

jobs:
  validate:
    name: Build and Validate
    runs-on: ubuntu-latest
    env:
      IS_NEXT_BUILD: "1"
      DB_USER: ci_user
      DB_PASS: ci_pass
      DB_NAME: ci_db
      SECRET_KEY: ci_secret_key_fixed
      NEXT_TELEMETRY_DISABLED: 1
      APP_PORT: 60000
      APP_URL: http://localhost:60000
      COMPOSE_PROJECT_NAME: ideon_ci
      ENV_FILE: .env.ci

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Security audit
        run: npm audit --audit-level=high

      - name: Lint and Type-check
        run: npm run check

      - name: Run unit tests
        run: npm run test

      - name: Build application
        run: npm run build

      - name: Setup CI Environment
        run: |
          # Ensure NODE_ENV is production for the runtime simulation
          export NODE_ENV=production

          # Create env file from current environment (filtered to relevant vars)
          printenv | grep -E '^(COMPOSE|APP|DB|SECRET|NODE|NEXT)_' > .env.ci

          # Configure Docker Compose for CI:
          # 1. Switch from pre-built image to local build
          # 2. Remove fixed container names to avoid conflicts
          # 3. Suffix volumes with run ID to ensure fresh data for each run
          sed -e "s|image: ghcr.io/3xpyth0n/ideon:latest|build: .|g" \
              -e '/container_name:/d' \
              -e "s/ideon-app-data/ideon-app-data-${{ github.run_id }}/g" \
              -e "s/ideon-db-data/ideon-db-data-${{ github.run_id }}/g" \
              docker-compose.yml > docker-compose.ci.yml

      - name: Start Stack (Production Simulation)
        run: docker compose -f docker-compose.ci.yml up -d --build --wait

      - name: Show logs on failure
        if: failure()
        run: docker compose -f docker-compose.ci.yml logs

      - name: Teardown
        if: always()
        env:
          ENV_FILE: .env.ci
        run: docker compose -f docker-compose.ci.yml --env-file .env.ci down -v --rmi local

  shellcheck:
    name: Shell script linting
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Run shellcheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: "."
          format: gcc
          severity: error
          shell: bash

  secret-scan:
    name: Secret scanning
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@v3.92.5
        with:
          path: ./
          base: ${{ github.event_name == 'push' && github.event.before || (github.event_name == 'pull_request' && github.event.pull_request.base.sha || '') }}
          head: ${{ github.event_name == 'push' && github.event.after || (github.event_name == 'pull_request' && github.event.pull_request.head.sha || 'HEAD') }}
